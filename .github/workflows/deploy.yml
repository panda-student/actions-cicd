# 通用部署配置
# 根据分支自动生成镜像标签，无需环境配置文件
name: 通用部署
on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    name: 部署${{ github.ref_name }}环境
    runs-on: ${{ github.ref_name }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        
      - name: 执行部署
        working-directory: deployment
        run: |
          # 清理旧镜像（保留最近的3个镜像）
          docker images --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | grep "$(basename $(pwd)/../)" | tail -n +4 | awk '{print $1}' | xargs -r docker rmi
          
          # 停止并删除容器
          docker compose down || true
          
          # 生成包含日期时间的镜像标签
          IMAGE_TAG=${{ github.ref_name }}-$(date +%Y%m%d-%H%M%S)
          
          # 获取项目目录名作为镜像名称
          PROJECT_NAME=$(basename $(pwd)/../)
          
          # 构建镜像并启动容器
          docker compose up -d --build
          
          echo "✅ 部署完成 - 镜像: $PROJECT_NAME:$IMAGE_TAG"