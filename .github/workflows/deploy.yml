# 通用部署配置
# 根据分支自动生成镜像标签，无需环境配置文件

name: 通用部署

on:
  push:
    branches:
      - main
      - dev
      - develop
      - '**'  # 匹配所有分支

jobs:
  deploy:
    name: 部署${{ github.ref_name }}环境
    runs-on: self-hosted
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        
      - name: 设置镜像标签
        id: set-image-tag
        run: echo "IMAGE_TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          
      - name: 执行部署
        working-directory: deployment
        run: |
          docker compose down || true
          IMAGE_TAG=${{ steps.set-image-tag.outputs.IMAGE_TAG }} docker compose up -d --build
          echo "✅ 部署完成 - 镜像: actions-cicd:${{ steps.set-image-tag.outputs.IMAGE_TAG }}"
