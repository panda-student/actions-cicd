# é€šç”¨éƒ¨ç½²é…ç½®
# æ ¹æ®åˆ†æ”¯è‡ªåŠ¨ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼Œæ— éœ€ç¯å¢ƒé…ç½®æ–‡ä»¶
# æ­¤å·¥ä½œæµé€‚ç”¨äºä»»æ„é¡¹ç›®ï¼Œåªéœ€ç»´æŠ¤deploymentç›®å½•ä¸‹çš„é…ç½®

name: é€šç”¨éƒ¨ç½²

on:
  push:
    branches:
      - main
      - dev
      - develop
      - '**'  # åŒ¹é…æ‰€æœ‰åˆ†æ”¯

jobs:
  deploy:
    name: éƒ¨ç½²${{ github.ref_name }}ç¯å¢ƒ
    runs-on: self-hosted
    
    # å…è®¸æ‰€æœ‰åˆ†æ”¯éƒ¨ç½²
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®é•œåƒæ ‡ç­¾
        id: set-image-tag
        run: |
          # ç›´æ¥ä½¿ç”¨åˆ†æ”¯åä½œä¸ºé•œåƒæ ‡ç­¾
          echo "IMAGE_TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          
      - name: æ‰§è¡Œéƒ¨ç½²
        working-directory: deployment
        run: |
          # åœæ­¢å¹¶ç§»é™¤ç°æœ‰å®¹å™¨
          docker compose down || true
          
          # æ„å»ºå¹¶å¯åŠ¨æ–°å®¹å™¨
          IMAGE_TAG=${{ steps.set-image-tag.outputs.IMAGE_TAG }} docker compose up -d --build
          
          # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "ğŸ³ é•œåƒåç§°: actions-cicd:${{ steps.set-image-tag.outputs.IMAGE_TAG }}"
          echo "ğŸ“¦ å®¹å™¨åç§°: deployment-app-1"
