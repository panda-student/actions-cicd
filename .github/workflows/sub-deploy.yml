# æœ€å°åŒ–Dockeréƒ¨ç½²å·¥ä½œæµæ¨¡æ¿
# devåˆ†æ”¯å’Œmainåˆ†æ”¯æ¨é€æ—¶è‡ªåŠ¨é€‰æ‹©ç¯å¢ƒé…ç½®æ–‡ä»¶æ‰§è¡Œ

name: æœ€å°åŒ–éƒ¨ç½²æ¨¡æ¿

on:
  workflow_call:
    inputs:
      # å¿…éœ€é…ç½®
      environment:
        required: true
        type: string
        description: "éƒ¨ç½²ç¯å¢ƒåç§°ï¼ˆç”Ÿäº§/æµ‹è¯•ï¼‰"
      image_name:
        required: true
        type: string
        description: "Dockeré•œåƒåç§°"

jobs:
  minimal-deploy:
    name: éƒ¨ç½²${{ inputs.environment }}ç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éƒ¨ç½²åº”ç”¨
        working-directory: deployment
        run: |
          # åœæ­¢å¹¶ç§»é™¤ç°æœ‰å®¹å™¨
          docker compose --env-file .env.${{ inputs.environment == 'ç”Ÿäº§' && 'prod' || 'test' }} down || true
          
          # æ„å»ºå¹¶å¯åŠ¨æ–°å®¹å™¨
          docker compose --env-file .env.${{ inputs.environment == 'ç”Ÿäº§' && 'prod' || 'test' }} up -d --build
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          docker compose --env-file .env.${{ inputs.environment == 'ç”Ÿäº§' && 'prod' || 'test' }} ps
          
          # è·å–ç«¯å£æ˜ å°„ä¿¡æ¯å¹¶æ˜¾ç¤ºè®¿é—®åœ°å€
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯æ±‡æ€»ï¼š"
          echo "========================================"
          echo "ğŸ·ï¸  ç¯å¢ƒåç§°: ${{ inputs.environment }}"
          echo "ğŸ³ é•œåƒåç§°: ${{ inputs.image_name }}"
          echo "ğŸ• éƒ¨ç½²æ—¶é—´: $(date)"
          echo ""
          
          # è¯»å–ç¯å¢ƒå˜é‡æ–‡ä»¶è·å–ç«¯å£æ˜ å°„
          ENV_FILE=".env.${{ inputs.environment == 'ç”Ÿäº§' && 'prod' || 'test' }}"
          PORT_MAPPING=$(grep "PORT_MAPPING" $ENV_FILE | cut -d'=' -f2)
          
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "   - æœ¬åœ°è®¿é—®: http://localhost:$PORT_MAPPING"
          echo "   - ç½‘ç»œè®¿é—®: http://$(hostname -I | awk '{print $1}'):$PORT_MAPPING"
          echo ""
          echo "ğŸ” å®¹å™¨çŠ¶æ€:"
          docker compose --env-file $ENV_FILE ps
          echo ""
          echo "âœ… ${{ inputs.environment }}ç¯å¢ƒå·²æˆåŠŸéƒ¨ç½²ï¼"
          echo "========================================"